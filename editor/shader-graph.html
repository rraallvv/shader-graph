<dom-module id="shader-graph">
	<link rel="import" type="css" href="css/bootstrap.css">
	<link rel="import" type="css" href="css/graph.css">

	<template>
		<div id="content" class="container-full">loading...</div>
	</template>

	<script src="js/external/jsplumb.js"></script>
	<script src="js/external/react.js"></script>
	<script src="js/external/react-dom.js"></script>
	<script src="js/external/glsl-optimizer-init.js"></script>
	<script src="js/external/glsl-optimizer.js"></script>
	<script src="../build/shadergraph.js"></script>
	<script src="js/editor.js"></script>

	<!--<script type="text/babel">-->
	<script>
		if ( typeof Editor === "undefined" ) {
			window.Editor = { polymerElement: Polymer, log: console.log };
		}

		var shaderGraph;

		Editor.polymerElement({
			ready: function(){
				shaderGraph = this;

				shaderGraph._editor = ReactDOM.render(React.createElement(NodeEditor), shaderGraph.$.content);

				//*
				var data = {
					nodes: [
						{type:"value", pos:[0, 0], value:70},
						{type:"uv", pos:[0, 100]},
						{type:"value", pos:[0, 220], value:35},
						{type:"value", pos:[0, 320], value:0.5},
						{type:"multiply", pos:[200, 50]},
						{type:"multiply", pos:[200, 150]},
						{type:"cos", pos:[350, 50]},
						{type:"sin", pos:[350, 150]},
						{type:"join", pos:[500, 100]},
						{type:"value", pos:[300, 300], value: 1}
					],
					links: [
						[2, 6],
						[3.1, 6.1],
						[3.2, 7],
						[4, 7.1],
						[6, 8],
						[7, 9],
						[8, 10],
						[9, 10.1],
						[5, 10.2],
						[11, 10.3],
						[10, 1]
					]
				};
				//*/
				/*
				var nodes = [
					{type:"fragColor", pos:[660, 200]},
					{type:"texture", pos:[0, 0]},
					{type:"split", pos:[0, 170]},
					{type:"add", pos:[135, 90]},
					{type:"add", pos:[267, 90]},
					{type:"divide", pos:[400, 90]},
					{type:"value", pos:[250, 175], value:3},
					{type:"join", pos:[530, 170]}
				];
				var links = [
					[2, 3],
					[3, 4],
					[3.1, 4.1],
					[4, 5],
					[3.2, 5.1],
					[5, 6],
					[7, 6.1],
					[6, 8],
					[6, 8.1],
					[6, 8.2],
					[3.3, 8.3],
					[8, 1]
				];
				//*/
				shaderGraph._editor.loadGraph(data);

			},
			updateShader() {
				this._editor.updateShader();
			},
			nodeList: function() {
				return shaderGraph._editor.nodeTypes().map(function (type) {
					var item = document.createElement("a");
					item.type = item.innerHTML = type;
					return item;
				});
			},
			addNode: function(e) {
				var b = graph.querySelector("#canvas").getBoundingClientRect();
				var pos = e.pos || [0, 0];
				pos[0] -= b.left;
				pos[1] -= b.top;
				e.pos = pos;
				shaderGraph._editor.addNode(e);
			},
			setTransform: function( s, r, n, t ){
				// s = 1, r = 1, n = 0, t = 0;
				this.style.transform = "matrix(" +
					s + ", 0, 0, " +
					r + ", " +
					Math.round(n + 0.5 * this.offsetWidth * (s - 1)) + ", " +
					Math.round(t + 0.5 * this.offsetHeight * (r - 1)) + ")";
			}
		});
	</script>
</dom-module>
